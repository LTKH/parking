<div class="row">

    <div class="col-xl">

        <div class="card border-0 mb-3 overflow-hidden text-silver">

            <div class="card-body">
                <div class="panel-body">
                    <div id="data-table-default_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                        <form id="parking-form" class="row g-3">
                            <div class="row mb-2">
                                <div class="text-silver f-w-600 f-s-16"><b>Сведения о автомобиле:</b></div>
                                <div class="col-sm-9">
                                    <div class="form-group row">
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Гос. номер:</label>
                                            <input id="search" name="carNumber" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-3 input-group-sm">
                                            <label class="form-label">Марка:</label>
                                            <input name="brand" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Цвет:</label>
                                            <input name="color" type="text" class="form-control" style="font-size: 12px;">
                                        </div>
                                        <div class="col-md-5 input-group-sm">
                                            <label class="form-label">Примечание:</label>
                                            <input name="note" type="text" class="form-control" style="font-size: 12px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="m-b-2 text-silver f-w-600 f-s-16"><b>Сведения о владельце:</b></div>
                                <div class="col-sm-9">
                                    <div class="form-group row">
                                        <div class="col-md-4 input-group-sm">
                                            <label class="form-label">ФИО владельца:</label>
                                            <input  id="search" name="fullName" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Телефон:</label>
                                            <input name="telephone" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-4 input-group-sm">
                                            <label class="form-label">Адрес владельца:</label>
                                            <input name="address" type="text" class="form-control" style="font-size: 12px;">
                                        </div>
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Документ:</label>
                                            <input name="document" type="text" class="form-control" style="font-size: 12px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="m-b-2 text-silver f-w-600 f-s-16"><b>Сведения о оплате:</b></div>
                                <div class="col-sm-9">
                                    <div class="form-group row">
                                        <!--div class="col-md-1 input-group-sm">
                                            <label class="form-label">№ чека</label>
                                            <input name="receipt" type="text" class="form-control" style="font-size: 12px;" disabled>
                                        </div-->
                                        <div class="col-md-2 input-group-sm date">
                                            <label class="form-label">Число от:</label>
                                            <input id="startDate" name="startDate" type="text" class="form-control" autocomplete="off" style="font-size: 12px;" required>
                                            <!--span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span-->
                                        </div>
                                        <div class="col-md-3 input-group-sm">
                                            <label class="form-label">Вид расценки:</label>
                                            <!--input name="price" type="text" class="form-control" style="font-size: 12px;"-->
                                            <select name="price" class="form-select form-select-sm" style="font-size: 12px;">
                                                <option selected disabled value=""></option>
                                            </select>
                                        </div>
                                        <div class="col-md-1 input-group-sm">
                                            <label class="form-label">Дней:</label>
                                            <input name="days" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Сумма:</label>
                                            <input name="cost" type="text" class="form-control" style="font-size: 12px;" required>
                                        </div>
                                        <div class="col-md-2 input-group-sm">
                                            <label class="form-label">Место:</label>
                                            <select name="idPlace" class="form-select form-select-sm" style="font-size: 12px;" required>
                                                <option selected disabled value=""></option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 input-group-sm date">
                                            <label class="form-label">Число до:</label>
                                            <input id="endDate" name="endDate" type="text" class="form-control" autocomplete="off" style="font-size: 12px;" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group row">
                                        <div class="col-md-4 input-group-sm date">
                                            <label class="form-label">&nbsp;</label>
                                            <button id="parking-save" type="button" class="btn btn-primary form-control" style="font-size: 12px;">Въезд</button>
                                        </div>
                                        <!--div class="col-md-1 input-group-sm">
                                            <button id="parking-save" type="button" class="btn btn-primary btn-sm mb-3">Сохранить</button>
                                        </div-->
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!-- end row -->
                        <div class="row">
                            <div class="col-sm-12">
                                <table 
                                    id="parking" 
                                    data-height="1000" 
                                    data-pagination-parts="pageInfo" 
                                    data-row-style="rowStyle" 
                                    data-show-print="true" 
                                    data-show-export="true" 
                                    class="table table-responsive-sm table-sm table-hover">
                                    <thead></thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

</div>

<!-- context menu -->
<ul id="context-menu" class="dropdown-menu" style="font-size: 12px;">
    <li data-item="exit"><a class="dropdown-item">Выезд автомобиля</a></li>
    <li data-item="entry"><a class="dropdown-item">Продлить оплату</a></li>
    <li data-item="print"><a class="dropdown-item">Распечатать чек</a></li>
    <!--li data-item="car"><a class="dropdown-item">Сведения об автомобиле</a></li-->
    <!--li data-item="owner"><a class="dropdown-item">Сведения о владельцах</a></li-->
</ul>  

<!-- Модальное окно -->
<div id="entry-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Автомобиль</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="form">
                    <input name="id" type="hidden" class="form-control" style="font-size: 12px;">
                    <input name="brand" type="hidden" class="form-control" style="font-size: 12px;">
                    <input name="color" type="hidden" class="form-control" style="font-size: 12px;">
                    <input name="idPlace" type="hidden" class="form-control" style="font-size: 12px;">
                    <input name="fullName" type="hidden" class="form-control" style="font-size: 12px;">
                    <table style="width: 100%;">
                        <tr>
                            <td>Автомобиль:&nbsp;</td>
                            <td colspan="3">
                                <input name="carNumber" class="form-control form-control-sm" style="font-size: 12px;" disabled>
                            </td>
                        </tr>
                        <tr>
                            <td>Вид&nbsp;расценки:&nbsp;</td>
                            <td colspan="3">
                                <select name="price" class="form-select form-select-sm" style="font-size: 12px;">
                                    <option selected disabled value=""></option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Кол.&nbsp;дней:</td>
                            <td><input name="days" type="text" class="form-control form-control-sm" style="font-size: 12px;"></td>
                            <td>&nbsp;&nbsp;Сумма:</td>
                            <td><input name="cost" type="text" class="form-control form-control-sm" style="font-size: 12px;"></td>
                        </tr>
                        <tr height="20px">
                            <td align="center" colspan="4">Действителен:</td>
                        </tr>
                        <tr>
                            <td align="right">с:&nbsp;</td>
                            <td><input id="startDate" name="startDate" type="text" class="form-control form-control-sm" autocomplete="off" style="font-size: 12px;" disabled></td>
                            <td align="right">по:&nbsp;</td>
                            <td><input id="endDate" name="endDate" type="text" class="form-control form-control-sm" autocomplete="off" style="font-size: 12px;"></td>
                        </tr>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <button id="save-button" type="button" class="btn btn-sm btn-primary">Сохранить</button>
                <button id="close-button" type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    function rowStyle(row, index) {
        if (row.status == 0) {
            return {
                css: {
                    color: 'hsl(210,8%,75%);'
                }
            }
        }
        if (row.debtor > 0) {
            return {
                css: {
                    color: 'red'
                }
            }
        }
        return {}
    }

    function printCheck(cont){
        var newWin = window.open('', 'PRINT');
        newWin.document.write(cont);
        newWin.document.close();
        newWin.focus(); // necessary for IE >= 10*/
        newWin.print();
        newWin.close();
    }

    function clearParkingForn() {
        $("#parking-form select").val('').change();
        $("#parking-form input[name='carNumber']").val('');
        $("#parking-form input[name='brand']").val('');
        $("#parking-form input[name='color']").val('');
        $("#parking-form input[name='note']").val('');
        $("#parking-form input[name='fullName']").val('');
        $("#parking-form input[name='telephone']").val('');
        $("#parking-form input[name='address']").val('');
        $("#parking-form input[name='document']").val('');
        $("#parking-form input[name='startDate']").val('');
        $("#parking-form input[name='days']").val('');
        $("#parking-form input[name='cost']").val('');
        $("#parking-form input[name='endDate']").val('');
    }

    function request(url, method, data) {
        $.ajax({
            url: url,
            method: method,
            data: data
        }).done(function(jsn) {
            if (url == "/api/v1/places" && method == 'GET'){
                $("select[name='idPlace']").empty();
                $.each(jsn.data, function(key, value) {
                    /*
                    if ($("#parking-form input[name='startDate']").val() != ''){
                        if (Date.parse(value.endDate) > strToDate($("#parking-form input[name='startDate']").val())) {
                            return
                        }
                    }
                    */
                    $("select[name='idPlace']").append($('<option>', {
                        value: value.id,
                        text: value.number,
                    }));
                });
                $("select[name='idPlace']").val('').change();
            }
            if (url == "/api/v1/prices" && method == 'GET'){
                $("select[name='price']").empty();
                $("select[name='price']").append($('<option>', { value: '', text: '' }));
                $.each(jsn.data, function(key, value) {
                    $("select[name='price']").append($('<option>', {
                        value: value.id+'|'+value.numOfDays+'|'+value.totalCost+'|'+value.priceType,
                        text: value.carType+' - '+value.priceType,
                    }));
                });
            }
            if (url == "/api/v1/check" && method == 'GET'){
                printCheck(jsn);
            }
            if (url == "/api/v1/parking" && method == 'POST'){
                $('#entry-modal').modal('hide'); 
                clearParkingForn();
                loadParking();
            }
            if (url == "/api/v1/parking" && method == 'DELETE'){
                loadParking();
            }
        }).fail(function(e) { 
            if (e.status == 401 || e.status == 403){
                window.location.replace("/login.html"); 
            }
            $.gritter.add({
                title: e.responseJSON.status,
                text: e.responseJSON.error,
                image: '/images/warning.png',
                time: 10000,
                class_name: 'my-class'
            });
        });
    }

    function setStartDate(object) {
        var startDate = new Date();
        $(object+" input[name='startDate']").val($.format.date(startDate, 'dd.MM.yyyy HH:mm'));
    }

    function setEndDate(object) {
        if ($(object+" input[name='startDate']").val() == ''){
        //    setStartDate(object);
            return
        }

        var endDate = strToDate($(object+" input[name='startDate']").val());
        var days = Number($(object+" input[name='days']").val());
        endDate.setDate(endDate.getDate() + days);

        $(object+" input[name='endDate']").val($.format.date(endDate, 'dd.MM.yyyy HH:mm'));

        strToDate($(object+" input[name='startDate']").val());
    }

    $(function() {

        $('#entry-modal .close').on('click', function () {
            $('#entry-modal').modal('hide');
        });

        $('#entry-modal #close-button').on('click', function () {
            $('#entry-modal').modal('hide');
        });

        $('#parking-save').on('click', function (){
            var validated = false;
            var serialize = $("#parking-form").serializeArray();
            for (var v in serialize) {
                switch(serialize[v].name) {
                    case 'carNumber':
                    case 'brand':
                    case 'fullName':
                    case 'telephone':
                    case 'startDate':
                    case 'days':
                    case 'cost':
                    case 'place':
                        if (serialize[v].value == '') {
                            validated = true;
                        }
                        break;
                }
            }
            if (validated) {
                $("#parking-form").addClass('was-validated');
                return;
            } else {
                $("#parking-form").removeClass('was-validated');
            }
            

            var price = $("#parking-form select[name='price']").val().split('|');
            var row = {
                'carNumber': $("#parking-form input[name='carNumber']").val(),
                'brand':     $("#parking-form input[name='brand']").val(),
                'color':     $("#parking-form input[name='color']").val(),
                'note':      $("#parking-form input[name='note']").val(),
                'fullName':  $("#parking-form input[name='fullName']").val(),
                'telephone': $("#parking-form input[name='telephone']").val(),
                'address':   $("#parking-form input[name='address']").val(),
                'document':  $("#parking-form input[name='document']").val(),
                'startDate': strToDate($("#parking-form input[name='startDate']").val()),
                'endDate':   strToDate($("#parking-form input[name='endDate']").val()),
                'days':      Number($("#parking-form input[name='days']").val()),
                'cost':      parseFloat($("#parking-form input[name='cost']").val()),
                'idPlace':   Number($("#parking-form select[name='idPlace']").val()),
                'priceType': price[3],
            }

            request("/api/v1/parking", "POST", JSON.stringify(row));
        });

        $('#save-button').on('click', function (){
            var price = $("#entry-modal select[name='price']").val().split('|');
            var row = {
                'id':        $("#entry-modal input[name='id']").val(),
                'carNumber': $("#entry-modal input[name='carNumber']").val(),
                'brand':     $("#entry-modal input[name='brand']").val(),
                'color':     $("#entry-modal input[name='color']").val(),
                'fullName':  $("#entry-modal input[name='fullName']").val(),
                'startDate': strToDate($("#entry-modal input[name='startDate']").val()),
                'endDate':   strToDate($("#entry-modal input[name='endDate']").val()),
                'days':      Number($("#entry-modal input[name='days']").val()),
                'cost':      parseFloat($("#entry-modal input[name='cost']").val()),
                'idPlace':   Number($("#entry-modal input[name='idPlace']").val()),
                'priceType': price[3],
            }

            request("/api/v1/parking", "POST", JSON.stringify(row));
        });

        $("#parking-form select[name='price']").change(function() {
            var price = this.value.split('|');
            if (price.length > 0){
                $("#parking-form input[name='days']").val(price[1]);
                $("#parking-form input[name='cost']").val(price[2]);
            } else {
                $("#parking-form input[name='days']").val('');
                $("#parking-form input[name='cost']").val('');
            }
            setEndDate("#parking-form");
        });

        $("#entry-modal select[name='price']").change(function() {
            var price = this.value.split('|');
            if (price.length > 0){
                $("#entry-modal input[name='days']").val(price[1]);
                $("#entry-modal input[name='cost']").val(price[2]);
            } else {
                $("#entry-modal input[name='days']").val('');
                $("#entry-modal input[name='cost']").val('');
            }
            setEndDate("#entry-modal");
        });

        $("#parking-form input[name='startDate']").change(function() {
            request("/api/v1/places", "GET"); 
            setEndDate("#parking-form");
        });

        $("#entry-modal input[name='endDate']").change(function() {
            var startDate = strToDate($("#entry-modal input[name='startDate']").val());
            var endDate = strToDate($("#entry-modal input[name='endDate']").val());
            var difference = endDate.getTime() - startDate.getTime();
            $("#entry-modal input[name='days']").val(Math.ceil(difference / (1000 * 3600 * 24)));
            $("#entry-modal input[name='days']").keyup();
        });

        $("#parking-form input[name='days']").keyup(function (){
            var price = $("#parking-form select[name='price']").val().split('|');
            $("#parking-form input[name='cost']").val((this.value*(parseFloat(price[2])/parseFloat(price[1]))).toFixed(2));
            setEndDate("#parking-form");
        });

        $("#entry-modal input[name='days']").keyup(function (){
            var price = $("#entry-modal select[name='price']").val().split('|');
            $("#entry-modal input[name='cost']").val((this.value*(parseFloat(price[2])/parseFloat(price[1]))).toFixed(2));
            setEndDate("#entry-modal");
        });

        $('#parking').bootstrapTable({
            pagination: true,
            //classes: "table table-responsive-sd table-sd",
            pageSize: 1000,
            height: 800,
            columns: [
                { title: "Гос. номер", field: "carNumber", width: 100 },
                { title: "Марка", field: "brand", width: 150 },
                { title: "Владелец", field: "fullName", width: 200 },
                { title: "Телефон", field: "telephone", width: 110 },
                { title: "Въезд", field: "startDate", width: 150 },
                { title: "Оплата до", field: "endDate", width: 150 },
                { title: "Место", field: "placeNumber", width: 80 },
                { title: "Оплата", field: "payment" },
            ],
            exportDataType: $(this).val(),
            exportTypes: ['csv', 'txt', 'excel'],
            contextMenu: '#context-menu',
            onContextMenuItem: function(row, e){
                if(e.data("item") == "exit"){
                    request("/api/v1/parking", "DELETE", JSON.stringify({ id: row.id }));
                }
                if(e.data("item") == "entry"){
                    if (row.endDate == ''){
                        row.endDate = $.format.date(new Date(), 'dd.MM.yyyy 00:00');
                    }

                    $('#entry-modal select[name="price"]').val('').change();
                    $('#entry-modal input[name="days"]').val('');
                    $('#entry-modal input[name="cost"]').val('');
                    $('#entry-modal input[name="idPlace"]').val(row.idPlace);
                    $('#entry-modal input[name="id"]').val(row.id);
                    $('#entry-modal input[name="brand"]').val(row.brand);
                    $('#entry-modal input[name="color"]').val(row.color);
                    $('#entry-modal input[name="carNumber"]').val(row.carNumber);
                    $('#entry-modal input[name="fullName"]').val(row.fullName);
                    $('#entry-modal input[name="startDate"]').val(row.endDate);
                    $('#entry-modal input[name="endDate"]').val(''); 

                    $("#entry-modal select[name='price'] > option").each(function() {
                        var price = this.value.split('|');
                        if (price.length > 0 && price[3] == row.priceType) {
                            $('#entry-modal select[name="price"]').val(this.value);
                            $('#entry-modal select[name="price"]').change();
                            return;
                        }
                    });

                    $('#entry-modal').modal('show');
                }
                if(e.data("item") == "print"){
                    //var mywindow = window.open('http://localhost:8000/api/v1/check?id='+row.idCheck);
                    //mywindow.focus();
                    //mywindow.print();
                    //mywindow.close();
                    request("/api/v1/check", "GET", { "id": row.idCheck });
                }
            }
        });

        loadParking();

        request("/api/v1/prices", "GET");
        request("/api/v1/places", "GET");
        
        $('#parking-form input[name="startDate"]').datetimepicker({
            format:'d.m.Y H:i'
        });

        $('#parking-form input[name="endDate"]').datetimepicker({
            format:'d.m.Y H:i'
        });

        $('#entry-modal input[name="startDate"]').datetimepicker({
            format:'d.m.Y H:i'
        });

        $('#entry-modal input[name="endDate"]').datetimepicker({
            format:'d.m.Y H:i'
        });

        /*
        $('#parking-form input[id="search"]').keyup(function(){
            $('#parking').bootstrapTable('filterBy', {}, {
                'filterAlgorithm': (row, filters) => {
                    if ($('#parking-form input[name="carNumber"]').val() != ""){
                        if (row.carNumber) {
                            if (row.carNumber.search($('#parking-form input[name="carNumber"]').val()) < 0) return 0;
                        } else {
                            return 0;
                        }
                    } 
                    if ($('#parking-form input[name="fullName"]').val() != ""){
                        if (row.fullName) {
                            if(row.fullName.search($('#parking-form input[name="fullName"]').val()) < 0) return 0;
                        } else {
                            return 0;
                        }
                    }
                    return 1;
                }
            });
        });
        */
    });
</script>
